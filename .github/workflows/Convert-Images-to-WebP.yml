name: Convert Images to WebP
run-name: Convert Images to WebP ${{github.run_number}}

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: false
        type: boolean

jobs:
  convert-to-webp:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 10

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆdev-webpãƒ–ãƒ©ãƒ³ãƒï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev-webp
          token: ${{ secrets.GITHUB_TOKEN }}

      # ImageMagickã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç”»åƒå¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼‰
      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      - name: Create directories
        run: |
          mkdir -p image/webp
          mkdir -p image/png

      # ç”»åƒã‚’WebPå½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç†
      - name: Convert images to WebP
        id: convert-to-webp
        run: |
          #!/bin/bash
          set -e
          
          # è¨­å®šå¤‰æ•°
          SOURCE_DIR="image/png"        # å¤‰æ›å…ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          OUTPUT_DIR="image/webp"       # å¤‰æ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          BLACKLIST_FILE="image/file_blacklist.txt"  # é™¤å¤–ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
          QUALITY=70                    # ç”»è³ªè¨­å®šï¼ˆ70%ï¼‰
          MAX_SIZE=2097152              # æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ2MBï¼‰
          
          # ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }
          
          # ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯é–¢æ•°
          is_blacklisted() {
            local file="$1"
            if [[ -f "$BLACKLIST_FILE" ]]; then
              # ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ã‚¹ä»˜ãã®å ´åˆã‚‚å¯¾å¿œï¼‰
              if grep -Fxq "$file" "$BLACKLIST_FILE" || grep -Fxq "./$file" "$BLACKLIST_FILE"; then
                return 0  # ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹
              fi
            fi
            return 1  # ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãªã„
          }
          
          # ç”»åƒå¤‰æ›å®Ÿè¡Œé–¢æ•°
          convert_image() {
            local input_file="$1"
            local filename=$(basename "$input_file")
            local name_without_ext="${filename%.*}"
            local output_file="$OUTPUT_DIR/${name_without_ext}.webp"
            
            log "Converting: $input_file -> $output_file"
            
            # æŒ‡å®šã—ãŸç”»è³ªã§WebPå¤‰æ›ã‚’å®Ÿè¡Œ
            if ! magick "$input_file" -quality $QUALITY "$output_file"; then
              log "ERROR: Failed to convert $input_file"
              return 1
            fi
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã¨ç”»è³ªèª¿æ•´
            local file_size=$(stat -c%s "$output_file")
            local current_quality=$QUALITY
            
            # 2MBã‚’è¶…ãˆã‚‹å ´åˆã¯ç”»è³ªã‚’ä¸‹ã’ã¦å†å¤‰æ›
            while [[ $file_size -gt $MAX_SIZE && $current_quality -gt 30 ]]; do
              current_quality=$((current_quality - 10))
              log "File too large (${file_size} bytes), reducing quality to ${current_quality}%"
              
              if ! magick "$input_file" -quality $current_quality "$output_file"; then
                log "ERROR: Failed to re-convert $input_file with quality ${current_quality}%"
                return 1
              fi
              
              file_size=$(stat -c%s "$output_file")
            done
            
            log "Converted successfully: ${filename} (${file_size} bytes, ${current_quality}% quality)"
            return 0
          }
          
          # ãƒ¡ã‚¤ãƒ³å¤‰æ›å‡¦ç†
          converted_count=0
          error_count=0
          
          log "Starting WebP conversion process..."
          log "Source directory: $SOURCE_DIR"
          log "Output directory: $OUTPUT_DIR"
          log "Quality setting: $QUALITY%"
          log "Max file size: $MAX_SIZE bytes"
          
          # ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          if [[ ! -d "$SOURCE_DIR" ]]; then
            log "WARNING: Source directory $SOURCE_DIR does not exist, creating it..."
            mkdir -p "$SOURCE_DIR"
            log "No files to convert in $SOURCE_DIR"
            echo "converted_count=0" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦å‡¦ç†
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            
            # ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
            if is_blacklisted "$filename"; then
              log "SKIPPED: $filename (blacklisted)"
              continue
            fi
            
            # æ—¢ã«WebPå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
            if [[ "$filename" =~ \.(webp)$ ]]; then
              log "SKIPPED: $filename (already WebP)"
              continue
            fi
            
            # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            name_without_ext="${filename%.*}"
            output_file="$OUTPUT_DIR/${name_without_ext}.webp"
            
            if [[ -f "$output_file" ]]; then
              log "SKIPPED: $filename (output already exists)"
              continue
            fi
            
            # å¤‰æ›å‡¦ç†ã¾ãŸã¯ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              log "DRY RUN: Would convert $file"
              converted_count=$((converted_count + 1))
            else
              if convert_image "$file"; then
                converted_count=$((converted_count + 1))
              else
                error_count=$((error_count + 1))
              fi
            fi
            
          done < <(find "$SOURCE_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -print0 2>/dev/null || true)
          
          log "Conversion completed!"
          log "Files converted: $converted_count"
          log "Errors: $error_count"
          
          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®å‡ºåŠ›è¨­å®š
          echo "converted_count=$converted_count" >> $GITHUB_OUTPUT
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

      # å¤‰æ›çµæœã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã§ãªã„å ´åˆã®ã¿ï¼‰
      - name: Commit and push changes
        if: ${{ inputs.dry_run != 'true' && steps.convert-to-webp.outputs.converted_count > 0 }}
        run: |
          # Gitã®è¨­å®šï¼ˆgithub-actions[bot]ã‚’ä½¿ç”¨ï¼‰
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
          if [[ -n $(git status --porcelain) ]]; then
            git add image/webp/
            git commit -m "ğŸ¨ Convert images to WebP format (#${{github.run_number}})
            
            - Converted ${{ steps.convert-to-webp.outputs.converted_count }} images
            - Quality: 70% (auto-adjusted if needed)
            - Max size: 2MB per file
            - Errors: ${{ steps.convert-to-webp.outputs.error_count }}"
            
            git push -u origin dev-webp
            echo "âœ… Changes committed and pushed successfully to dev-webp branch"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      # å®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ğŸ¨ WebP Conversion Results
          
          ## Summary
          - **Files converted**: ${{ steps.convert-to-webp.outputs.converted_count }}
          - **Errors**: ${{ steps.convert-to-webp.outputs.error_count }}
          - **Quality setting**: 70% (initial)
          - **Max file size**: 2MB
          - **Dry run**: ${{ inputs.dry_run }}
          - **Branch**: dev-webp
          
          ## Settings Used
          - **Source directory**: \`image/png/\`
          - **Output directory**: \`image/webp/\`
          - **Blacklist file**: \`image/file_blacklist.txt\`
          - **Supported formats**: JPG, JPEG, PNG, GIF â†’ WebP
          
          ## Technical Details
          - **Conversion command**: \`magick input -quality 70 output.webp\`
          - **Size optimization**: Quality reduced by 10% steps if file > 2MB
          - **Minimum quality**: 30%
          
          EOF
